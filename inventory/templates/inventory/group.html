{% extends "inventory/base.html" %}
{% load static %}

{% block title %}Create a Clubbed Device{% endblock %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- Soft Message Container -->
<div id="message-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 transform opacity-0">
    <div id="message-box" class="px-6 py-3 rounded-full shadow-lg text-white font-semibold flex items-center gap-2">
        <i id="message-icon" class="fas"></i>
        <span id="message-text"></span>
    </div>
</div>

<div class="flex justify-center items-center min-h-screen bg-gray-100">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl p-6">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h2 class="text-2xl font-bold text-gray-800">Create a Clubbed Device</h2>
            <a href="{% url 'inventory:dashboard' %}" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </a>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input type="text" id="searchInput"
                   class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                   placeholder="Search by name, UID, or serial number">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Available Items -->
            <div>
                <h3 class="text-lg font-semibold mb-3">Select Component</h3>
                <ul id="itemsList" class="border rounded-lg p-3 h-64 overflow-y-auto space-y-2 bg-gray-50">
                    {% for item in items %}
                        <li class="flex justify-between items-center bg-white shadow-sm px-3 py-2 rounded">
                            <span>{{ item.item_name }} ({{ item.uid_no }})</span>
                            <button type="button"
                                    class="add-btn bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded"
                                    data-id="{{ item.id }}" data-name="{{ item.item_name }}" data-uid="{{ item.uid_no }}">
                                Add
                            </button>
                        </li>
                    {% empty %}
                        <li class="text-gray-500">No items available.</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Selected Items -->
            <div>
                <h3 class="text-lg font-semibold mb-3">
                    Selected Components (<span id="selectedCount">0</span>)
                </h3>
                <ul id="selectedItems" class="border rounded-lg p-3 h-64 overflow-y-auto space-y-2 bg-gray-50">
                    <!-- Dynamically added here -->
                </ul>
            </div>
        </div>

        <!-- Kit Name Input -->
        <div class="mt-6">
            <label for="kitName" class="block text-sm font-medium text-gray-700 mb-1">Device Name</label>
            <input type="text" id="kitName"
                   class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"
                   placeholder="Enter a name for your Device">
        </div>

        <!-- Actions -->
        <div class="flex justify-end mt-6 space-x-3">
            <a href="{% url 'inventory:dashboard' %}"
               class="px-5 py-2 rounded-lg border bg-gray-200 hover:bg-gray-300 text-gray-700">Cancel</a>
            <button id="createKitBtn"
                    class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">
                Create Device
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("searchInput");
        const itemsList = document.getElementById("itemsList");
        const selectedItems = document.getElementById("selectedItems");
        const selectedCount = document.getElementById("selectedCount");
        const kitName = document.getElementById("kitName");
        const createKitBtn = document.getElementById("createKitBtn");
        
        // Soft message elements
        const messageContainer = document.getElementById("message-container");
        const messageBox = document.getElementById("message-box");
        const messageIcon = document.getElementById("message-icon");
        const messageText = document.getElementById("message-text");

        let selected = [];

        // Function to show a soft message
        function showMessage(message, isSuccess = true) {
            messageText.textContent = message;
            
            // Set message styles based on success or error
            if (isSuccess) {
                messageBox.className = "px-6 py-3 rounded-full shadow-lg text-white font-semibold flex items-center gap-2 bg-green-500";
                messageIcon.className = "fas fa-check-circle";
            } else {
                messageBox.className = "px-6 py-3 rounded-full shadow-lg text-white font-semibold flex items-center gap-2 bg-red-500";
                messageIcon.className = "fas fa-exclamation-circle";
            }
            
            // Show the message with a slight delay to trigger the transition
            setTimeout(() => {
                messageContainer.classList.remove("opacity-0");
                messageContainer.classList.add("opacity-100");
            }, 10);
            
            // Hide the message after 3 seconds
            setTimeout(() => {
                messageContainer.classList.remove("opacity-100");
                messageContainer.classList.add("opacity-0");
            }, 3000);
        }

        // reset form each load
        selected = [];
        selectedItems.innerHTML = "";
        selectedCount.textContent = "0";
        kitName.value = "";

        // search filter
        searchInput.addEventListener("input", function () {
            const query = this.value.toLowerCase();
            itemsList.querySelectorAll("li").forEach(li => {
                const text = li.textContent.toLowerCase();
                li.style.display = text.includes(query) ? "" : "none";
            });
        });

        // add item
        itemsList.addEventListener("click", (e) => {
            if (e.target.classList.contains("add-btn")) {
                const id = e.target.dataset.id;
                const name = e.target.dataset.name;
                const uid = e.target.dataset.uid;

                if (!selected.find(item => item.id === id)) {
                    selected.push({id, name, uid});

                    const li = document.createElement("li");
                    li.className = "flex justify-between items-center bg-white shadow-sm px-3 py-2 rounded";
                    li.innerHTML = `<span>${name} (${uid})</span>
                                     <button type="button" class="remove-btn text-red-500 text-sm" data-id="${id}">Remove</button>`;
                    selectedItems.appendChild(li);

                    selectedCount.textContent = selected.length;
                }
            }
        });

        // remove item
        selectedItems.addEventListener("click", (e) => {
            if (e.target.classList.contains("remove-btn")) {
                const id = e.target.dataset.id;
                selected = selected.filter(item => item.id !== id);
                e.target.parentElement.remove();
                selectedCount.textContent = selected.length;
            }
        });

        // create kit
        createKitBtn.addEventListener("click", () => {
            if (!kitName.value.trim()) {
                showMessage("Please enter a Device name.", false);
                return;
            }
            if (selected.length === 0) {
                showMessage("Please add at least one item.", false);
                return;
            }

            const formData = new FormData();
            formData.append("kit_name", kitName.value);
            selected.forEach(item => formData.append("item_ids[]", item.id));

            fetch("{% url 'inventory:create_kit' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, true);
                    // The original code was redirecting immediately. It's better to
                    // wait for the message to be seen before redirecting.
                    setTimeout(() => {
                        window.location.href = "{% url 'inventory:dashboard' %}";
                    }, 1000);
                } else {
                    showMessage("Error: " + data.message, false);
                }
            })
            .catch(err => {
                showMessage("Something went wrong: " + err, false);
            });
        });
    });
</script>

{% endblock %}

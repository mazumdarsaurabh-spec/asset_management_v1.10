{% extends 'inventory/base.html' %}
{% load static %}
{% load custom_filters %}
{% load widget_tweaks %}

{% block title %}Edit Item{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card p-4 mx-auto" style="max-width: 800px;">
        <h2 class="card-title text-center mb-4">Edit Item: {{ item.item_name }}</h2>

        {% include 'inventory/messages.html' %}

        <div class="mb-4">
            <h4 class="card-subtitle mb-3">Item Details</h4>
            <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}

                <input type="hidden" name="item_submit" value="1">
                {# Invoice Number #}
                <tr>
                    <td><label for="{{ item_form.invoice_number.id_for_label }}" class="form-label">Invoice Number:</label></td>
                    <td>
                        {% render_field item_form.invoice_number class="form-control" id="id_invoice_number" %}
                        {% if item_form.invoice_number.errors %}
                            <div class="text-danger small">{{ item_form.invoice_number.errors }}</div>
                        {% endif %}
                    </td>
                </tr>

                <table class="table table-borderless">
                    {# Item Name #}
                    <tr>
                        <td><label for="{{ item_form.item_name.id_for_label }}" class="form-label">Item Name:</label></td>
                        <td>
                            {% render_field item_form.item_name class="form-control" id="id_item_name" %}
                            {% if item_form.item_name.errors %}<div class="text-danger small">{{ item_form.item_name.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# Category #}
                    <tr>
                        <td><label for="{{ item_form.category.id_for_label }}" class="form-label">Category:</label></td>
                        <td>
                            {% render_field item_form.category class="form-control" id="id_category" %}
                            {% if item_form.category.errors %}<div class="text-danger small">{{ item_form.category.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# UID Number (Read-only) #}
                    <tr>
                        <td><label class="form-label">UID No:</label></td>
                        <td>
                            <input type="text" class="form-control" value="{{ item.uid_no|default:'N/A' }}" readonly>
                        </td>
                    </tr>
                    {# Serial number #}
                    <tr>
                        <td><label for="{{ item_form.serial_number.id_for_label }}" class="form-label">Serial number:</label></td>
                        <td>
                            {% render_field item_form.serial_number class="form-control" id="id_serial_number" %}
                            {% if item_form.serial_number.errors %}<div class="text-danger small">{{ item_form.serial_number.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# Quantity #}
                    <tr>
                        <td><label for="{{ item_form.quantity.id_for_label }}" class="form-label">Quantity:</label></td>
                        <td>
                            {% render_field item_form.quantity class="form-control" id="id_quantity" %}
                            {% if item_form.quantity.errors %}<div class="text-danger small">{{ item_form.quantity.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# Location #}
                    <tr>
                        <td><label for="{{ item_form.location.id_for_label }}" class="form-label">Location:</label></td>
                        <td>
                            {% render_field item_form.location class="form-control" id="id_location" %}
                            {% if item_form.location.errors %}<div class="text-danger small">{{ item_form.location.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# Status #}
                    <tr>
                        <td><label for="{{ item_form.status.id_for_label }}" class="form-label">Status:</label></td>
                        <td>
                            {% render_field item_form.status class="form-control" id="id_status" %}
                            {% if item_form.status.errors %}<div class="text-danger small">{{ item_form.status.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# Price #}
                    <tr>
                        <td><label for="{{ item_form.price.id_for_label }}" class="form-label">Price:</label></td>
                        <td>
                            {% render_field item_form.price class="form-control" id="id_price" %}
                            {% if item_form.price.errors %}<div class="text-danger small">{{ item_form.price.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# Description #}
                    <tr>
                        <td><label for="{{ item_form.description.id_for_label }}" class="form-label">Description:</label></td>
                        <td>
                            {% render_field item_form.description class="form-control" rows="3" id="id_description" %}
                            {% if item_form.description.errors %}<div class="text-danger small">{{ item_form.description.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# Project #}
                    <tr>
                        <td><label for="{{ item_form.project.id_for_label }}" class="form-label">Project:</label></td>
                        <td>
                            {% render_field item_form.project class="form-control" id="id_project" %}
                            {% if item_form.project.errors %}<div class="text-danger small">{{ item_form.project.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# Kit Field #}
                    <tr>
                        <td><label class="form-label">Kit:</label></td>
                        <td>
                            {% if item.kits.all %}
                                {% for kit in item.kits.all %}
                                    <span class="badge bg-primary me-2">{{ kit.name }}</span>
                                    <a href="{% url 'inventory:kit_items_list' pk=kit.pk %}" 
                                       class="btn btn-sm btn-outline-info">
                                       Manage
                                    </a>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">Not assigned to any kit</span>
                            {% endif %}
                        </td>
                    </tr>
                    
                    
                    {# Image #}
                    <tr>
                        <td><label for="{{ item_form.image.id_for_label }}" class="form-label">Image:</label></td>
                        <td>
                            {% if item.image %}
                                <img src="{{ item.image.url }}" alt="{{ item.item_name }}" class="img-thumbnail mb-2" style="max-width: 100px; max-height: 100px; object-fit: cover;">
                                <p class="small text-muted">Current: {{ item.image.name|split:'/'|last }}</p>
                            {% else %}
                                <p class="small text-muted">No image uploaded.</p>
                            {% endif %}
                            {% render_field item_form.image class="form-control-file" id="id_image" %}
                            {% if item_form.image.errors %}<div class="text-danger small">{{ item_form.image.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    {# CPU, GPU, OS, Software fields #}
                    <tr id="cpu_row" style="display: none;">
                        <td><label for="{{ item_form.cpu.id_for_label }}" class="form-label">CPU:</label></td>
                        <td>
                            {% render_field item_form.cpu class="form-control" id="id_cpu" %}
                            {% if item_form.cpu.errors %}<div class="text-danger small">{{ item_form.cpu.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    <tr id="gpu_row" style="display: none;">
                        <td><label for="{{ item_form.gpu.id_for_label }}" class="form-label">GPU:</label></td>
                        <td>
                            {% render_field item_form.gpu class="form-control" id="id_gpu" %}
                            {% if item_form.gpu.errors %}<div class="text-danger small">{{ item_form.gpu.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    <tr id="os_row" style="display: none;">
                        <td><label for="{{ item_form.os.id_for_label }}" class="form-label">Operating System:</label></td>
                        <td>
                            {% render_field item_form.os class="form-control" id="id_os" %}
                            {% if item_form.os.errors %}<div class="text-danger small">{{ item_form.os.errors }}</div>{% endif %}
                        </td>
                    </tr>
                    <tr id="installed_software_row" style="display: none;">
                        <td><label for="{{ item_form.installed_software.id_for_label }}" class="form-label">Installed Software:</label></td>
                        <td>
                            {% render_field item_form.installed_software class="form-control" rows="3" id="id_installed_software" %}
                            {% if item_form.installed_software.errors %}<div class="text-danger small">{{ item_form.installed_software.errors }}</div>{% endif %}
                        </td>
                    </tr>
                </table>


                <div class="d-flex justify-content-between mt-4">
                    <button type="submit" class="btn btn-info">Update Item </button>
                    <a href="{% url 'inventory:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                </div>
            </form>
        </div>

        <hr class="my-4">

        <div class="mb-4">
            <h4 class="card-subtitle mb-3">Upload New Document</h4>
            <form method="POST" action="{% url 'inventory:item_documents' item_id=item.pk %}" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="form-group mb-3">
                    <label for="id_tag" class="form-label">Document Type:</label>
                    {% render_field document_form.tag class="form-control" %}
                    {% if document_form.tag.errors %}<div class="text-danger small">{{ document_form.tag.errors }}</div>{% endif %}
                </div>
                <div class="form-group mb-3">
                    <label for="id_file" class="form-label">Document File:</label>
                    {% render_field document_form.file class="form-control" %}
                    {% if document_form.file.errors %}<div class="text-danger small">{{ document_form.file.errors }}</div>{% endif %}
                </div>
                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-info">Upload Document</button>
                </div>
            </form>
        </div>

        <hr class="my-4">
        
        <div class="mb-4">
            <h4 class="card-subtitle mb-3">Associated Documents</h4>
            {% if documents %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-light">
                            <tr>
                                <th>Tag</th>
                                <th>File</th>
                                <th>Uploaded By</th>
                                <th>Uploaded At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documents %}
                                <tr>
                                    <td>{{ doc.tag.name }}</td>
                                    <td><a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View File</a></td>
                                    <td>{{ doc.uploaded_by.username|default:"N/A" }}</td>
                                    <td>
                                        <form action="{% url 'inventory:delete_document' item_id=item.pk doc_id=doc.pk %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this document?');">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="alert alert-info">No documents associated with this item.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const categorySelect = document.getElementById('id_category');
        const cpuRow = document.getElementById('cpu_row');
        const gpuRow = document.getElementById('gpu_row');
        const osRow = document.getElementById('os_row'); 
        const installedSoftwareRow = document.getElementById('installed_software_row');
    
        const hardwareSoftwareFields = [cpuRow, gpuRow, osRow, installedSoftwareRow].filter(row => row !== null);
    
        function toggleHardwareSoftwareFields() {
            const selectedCategoryOption = categorySelect.options[categorySelect.selectedIndex];
            const selectedCategoryText = selectedCategoryOption ? selectedCategoryOption.textContent : '';
    
            const showForCategories = ['Laptop', 'Desktop', 'Server', 'Docking Station']; 
    
            if (showForCategories.includes(selectedCategoryText)) {
                hardwareSoftwareFields.forEach(row => {
                    row.style.display = 'table-row';
                });
            } else {
                hardwareSoftwareFields.forEach(row => {
                    row.style.display = 'none';
                });
            }
        }
    
        if (categorySelect) {
            categorySelect.addEventListener('change', toggleHardwareSoftwareFields);
            toggleHardwareSoftwareFields();
        }
    });
</script>
{% endblock %}
